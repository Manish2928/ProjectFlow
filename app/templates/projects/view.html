{% extends "layouts/base.html" %}

{% block title %}{{ project.title }} - Project Details{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">
            <i class="fas fa-project-diagram me-2"></i>
            {{ project.title }}
        </h1>
        {% set is_member = current_user.is_admin() or project.created_by == current_user.id or (project.members | selectattr('user_id', 'equalto', current_user.id) | list) %}
        <div class="btn-toolbar mb-2 mb-md-0">
            <div class="btn-group me-2">
                <a href="{{ url_for('projects.index') }}" class="btn btn-sm btn-outline-secondary">
                    <i class="fas fa-arrow-left me-1"></i>
                    Back to Projects
                </a>
                {% if is_member %}
                    <a href="{{ url_for('canvas.project_canvas', project_id=project.id) }}" class="btn btn-sm btn-primary">
                        <i class="fas fa-paint-brush me-1"></i>
                        Open Canvas
                    </a>
                    <button class="btn btn-sm btn-outline-info" id="project-chat-toggle">
                        <i class="fas fa-comments me-1"></i>
                        Team Chat
                        <span class="badge bg-danger ms-1" id="project-chat-badge" style="display: none;">0</span>
                    </button>
                {% endif %}
                {% if current_user.is_admin() or project.created_by == current_user.id %}
                    <a href="{{ url_for('projects.edit', project_id=project.id) }}" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-edit me-1"></i>
                        Edit Project
                    </a>
                    <button type="button" class="btn btn-sm btn-outline-success" data-bs-toggle="modal" data-bs-target="#inviteModal">
                        <i class="fas fa-user-plus me-1"></i>
                        Invite Users
                    </button>
                    <a href="{{ url_for('invitations.project_members', project_id=project.id) }}" class="btn btn-sm btn-outline-info">
                        <i class="fas fa-users me-1"></i>
                        Manage Members
                    </a>
                    <a href="{{ url_for('projects.create_task', project_id=project.id) }}" class="btn btn-sm btn-success">
                        <i class="fas fa-plus me-1"></i>
                        Add Task
                    </a>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Project Overview -->
    <div class="row g-4 mb-4">
        <div class="col-md-8">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Project Overview
                    </h5>
                </div>
                <div class="card-body">
                    {% if project.description %}
                        <p class="card-text">{{ project.description }}</p>
                    {% else %}
                        <p class="text-muted">No description provided.</p>
                    {% endif %}
                    
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <h6><i class="fas fa-user me-1"></i> Created by</h6>
                            <p>{{ project.creator.get_full_name() }}</p>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-calendar me-1"></i> Created on</h6>
                            <p>{{ project.created_at.strftime('%B %d, %Y') }}</p>
                        </div>
                    </div>
                    
                    {% if project.start_date or project.deadline %}
                    <div class="row">
                        {% if project.start_date %}
                        <div class="col-md-6">
                            <h6><i class="fas fa-calendar-alt me-1"></i> Start Date</h6>
                            <p>{{ project.start_date.strftime('%B %d, %Y') }}</p>
                        </div>
                        {% endif %}
                        {% if project.deadline %}
                        <div class="col-md-6">
                            <h6><i class="fas fa-calendar-times me-1"></i> Deadline</h6>
                            <p>{{ project.deadline.strftime('%B %d, %Y') }}</p>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    {% if project.budget %}
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-dollar-sign me-1"></i> Budget</h6>
                            <p>${{ "%.2f"|format(project.budget) }}</p>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-pie me-2"></i>
                        Project Status
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <span class="badge bg-{{ 'success' if project.status == 'completed' else 'primary' if project.status == 'active' else 'warning' if project.status == 'on_hold' else 'secondary' }} fs-6">
                            {{ project.status.replace('_', ' ').title() }}
                        </span>
                    </div>
                    
                    <div class="mb-3">
                        <span class="badge bg-{{ 'danger' if project.priority == 'urgent' else 'warning' if project.priority == 'high' else 'info' if project.priority == 'medium' else 'secondary' }} fs-6">
                            {{ project.priority.title() }} Priority
                        </span>
                    </div>
                    
                    <div class="mb-3">
                        <h6>Progress</h6>
                        <div class="progress mb-2" style="height: 20px;">
                            <div class="progress-bar" role="progressbar" style="width: {{ project.progress }}%" aria-valuenow="{{ project.progress }}" aria-valuemin="0" aria-valuemax="100">
                                {{ project.progress }}%
                            </div>
                        </div>
                    </div>
                    
                    <div class="row text-center">
                        <div class="col-6">
                            <h6 class="text-muted">Total Tasks</h6>
                            <h4 class="text-primary">{{ project.get_task_count() }}</h4>
                        </div>
                        <div class="col-6">
                            <h6 class="text-muted">Completed</h6>
                            <h4 class="text-success">{{ project.get_completed_tasks() }}</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Tasks Section -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">
                <i class="fas fa-tasks me-2"></i>
                Project Tasks
            </h5>
            {% if current_user.is_admin() or project.created_by == current_user.id %}
            <a href="{{ url_for('projects.create_task', project_id=project.id) }}" class="btn btn-sm btn-success">
                <i class="fas fa-plus me-1"></i>
                Add Task
            </a>
            {% endif %}
        </div>
        <div class="card-body">
            {% if tasks %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Task</th>
                                <th>Assigned To</th>
                                <th>Priority</th>
                                <th>Status</th>
                                <th>Due Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for task in tasks %}
                            <tr>
                                <td>
                                    <div>
                                        <strong>{{ task.title }}</strong>
                                        {% if task.description %}
                                        <br><small class="text-muted">{{ task.description[:100] }}{% if task.description|length > 100 %}...{% endif %}</small>
                                        {% endif %}
                                    </div>
                                </td>
                                <td>
                                    {% if task.assignee %}
                                        {{ task.assignee.get_full_name() }}
                                    {% else %}
                                        <span class="text-muted">Unassigned</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge bg-{{ 'danger' if task.priority == 'urgent' else 'warning' if task.priority == 'high' else 'info' if task.priority == 'medium' else 'secondary' }}">
                                        {{ task.priority.title() }}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge bg-{{ 'success' if task.status == 'completed' else 'warning' if task.status == 'in_progress' else 'secondary' }}">
                                        {{ task.status.replace('_', ' ').title() }}
                                    </span>
                                </td>
                                <td>
                                    {% if task.due_date %}
                                        {{ task.due_date.strftime('%m/%d/%Y') }}
                                        {% if task.is_overdue() %}
                                            <br><small class="text-danger">Overdue</small>
                                        {% endif %}
                                    {% else %}
                                        <span class="text-muted">No due date</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        {% if task.status != 'completed' and (current_user.is_admin() or task.assigned_to == current_user.id or task.created_by == current_user.id) %}
                                        <button type="button" class="btn btn-outline-success" onclick="TaskManager.updateStatus({{ task.id }}, 'completed')" title="Mark as Complete">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        {% endif %}
                                        {% if task.status == 'pending' and (current_user.is_admin() or task.assigned_to == current_user.id or task.created_by == current_user.id) %}
                                        <button type="button" class="btn btn-outline-primary" onclick="TaskManager.updateStatus({{ task.id }}, 'in_progress')" title="Start Task">
                                            <i class="fas fa-play"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-tasks fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No tasks yet</h5>
                    <p class="text-muted">Start by creating your first task for this project.</p>
                    {% if current_user.is_admin() or project.created_by == current_user.id %}
                    <a href="{{ url_for('projects.create_task', project_id=project.id) }}" class="btn btn-primary">
                        <i class="fas fa-plus me-1"></i>
                        Create First Task
                    </a>
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Project Chat Panel -->
<div class="project-chat-panel" id="project-chat-panel">
    <div class="chat-header">
        <h3><i class="fas fa-comments me-2"></i>Project Chat</h3>
        <button class="chat-close-btn" id="project-chat-close-btn" title="Close Chat">
            <i class="fas fa-times"></i>
        </button>
    </div>
    <div class="chat-messages" id="project-chat-messages">
        <!-- Messages will be loaded here -->
    </div>
    <div class="chat-input">
        <div class="chat-input-group">
            <textarea id="project-message-input" placeholder="Type your message..." rows="1"></textarea>
            <button class="chat-send-btn" id="project-send-message" title="Send Message">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
</div>

<!-- Invite Users Modal -->
<div class="modal fade" id="inviteModal" tabindex="-1" aria-labelledby="inviteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="inviteModalLabel">
                    <i class="fas fa-user-plus me-2"></i>
                    Invite Users to Project
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="userSearch" class="form-label">Search Users</label>
                    <input type="text" class="form-control" id="userSearch" placeholder="Search by name, username, or email...">
                    <small class="form-text text-muted">Type at least 2 characters to search</small>
                </div>
                
                <div id="searchResults" class="mb-3" style="display: none;">
                    <h6>Search Results:</h6>
                    <div id="userList" class="list-group"></div>
                </div>
                
                <div id="selectedUsers" style="display: none;">
                    <h6>Selected Users:</h6>
                    <div id="selectedUsersList" class="mb-3"></div>
                    
                    <div class="mb-3">
                        <label for="inviteRole" class="form-label">Role</label>
                        <select class="form-select" id="inviteRole">
                            <option value="member">Member (Can create, edit, view)</option>
                            <option value="viewer">Viewer (Can only view)</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="inviteMessage" class="form-label">Message (Optional)</label>
                        <textarea class="form-control" id="inviteMessage" rows="3" placeholder="Add a personal message to the invitation..."></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="sendInvitations" style="display: none;">
                    <i class="fas fa-paper-plane me-1"></i>
                    Send Invitations
                </button>
            </div>
        </div>
    </div>
</div>

<style>
/* Project Chat Panel Styles */
.project-chat-panel {
    width: 350px;
    background: var(--bs-body-bg);
    border-left: 1px solid var(--bs-border-color);
    display: flex;
    flex-direction: column;
    position: fixed;
    top: 0;
    right: 0;
    height: 100vh;
    z-index: 1000;
    transform: translateX(100%);
    transition: transform 0.3s ease;
    box-shadow: -2px 0 10px rgba(0,0,0,0.1);
}

.project-chat-panel.open {
    transform: translateX(0);
}

.project-chat-panel .chat-header {
    padding: 20px;
    border-bottom: 1px solid var(--bs-border-color);
    background: var(--bs-body-bg);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.project-chat-panel .chat-header h3 {
    margin: 0;
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--bs-body-color);
}

.project-chat-panel .chat-close-btn {
    background: none;
    border: none;
    color: var(--bs-body-color);
    font-size: 1.2rem;
    cursor: pointer;
    padding: 5px;
    border-radius: 4px;
    transition: background-color 0.2s ease;
}

.project-chat-panel .chat-close-btn:hover {
    background: var(--bs-secondary-bg);
}

.project-chat-panel .chat-messages {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
    max-height: calc(100vh - 200px);
}

.project-chat-panel .chat-message {
    margin-bottom: 15px;
    padding: 12px;
    border-radius: 12px;
    background: var(--bs-secondary-bg);
    animation: fadeInUp 0.3s ease;
}

.project-chat-panel .chat-message.own {
    background: var(--bs-primary);
    color: white;
    margin-left: 40px;
}

.project-chat-panel .chat-message.other {
    margin-right: 40px;
}

.project-chat-panel .message-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
    font-size: 0.875rem;
}

.project-chat-panel .message-author {
    font-weight: 600;
}

.project-chat-panel .message-time {
    color: var(--bs-secondary-color);
    font-size: 0.75rem;
}

.project-chat-panel .message-content {
    word-wrap: break-word;
    line-height: 1.4;
}

.project-chat-panel .chat-input {
    padding: 20px;
    border-top: 1px solid var(--bs-border-color);
    background: var(--bs-body-bg);
}

.project-chat-panel .chat-input-group {
    display: flex;
    gap: 10px;
    align-items: flex-end;
}

.project-chat-panel .chat-input textarea {
    flex: 1;
    background: var(--bs-body-bg);
    border: 1px solid var(--bs-border-color);
    color: var(--bs-body-color);
    border-radius: 20px;
    padding: 10px 15px;
    resize: none;
    min-height: 40px;
    max-height: 100px;
    font-family: inherit;
}

.project-chat-panel .chat-input textarea:focus {
    outline: none;
    border-color: var(--bs-primary);
}

.project-chat-panel .chat-send-btn {
    background: var(--bs-primary);
    color: white;
    border: none;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
}

.project-chat-panel .chat-send-btn:hover {
    transform: scale(1.05);
}

.project-chat-panel .chat-send-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
let selectedUsers = [];
let searchTimeout;

// Project Chat functionality
class ProjectChat {
    constructor() {
        this.projectId = {{ project.id }};
        this.currentUser = {
            id: {{ current_user.id }},
            name: "{{ current_user.get_full_name() }}"
        };
        this.messages = [];
        this.isOpen = false;
        this.unreadCount = 0;

        this.init();
    }

    init() {
        this.chatPanel = document.getElementById('project-chat-panel');
        this.chatMessages = document.getElementById('project-chat-messages');
        this.messageInput = document.getElementById('project-message-input');
        this.sendButton = document.getElementById('project-send-message');
        this.toggleButton = document.getElementById('project-chat-toggle');
        this.closeButton = document.getElementById('project-chat-close-btn');
        this.badge = document.getElementById('project-chat-badge');

        this.setupEventListeners();
        this.loadMessages();

        // Poll for new messages every 5 seconds
        setInterval(() => {
            this.loadMessages();
        }, 5000);
    }

    setupEventListeners() {
        // Toggle chat
        this.toggleButton.addEventListener('click', () => {
            this.toggleChat();
        });

        // Close chat
        this.closeButton.addEventListener('click', () => {
            this.toggleChat();
        });

        // Send message
        this.sendButton.addEventListener('click', () => {
            this.sendMessage();
        });

        this.messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                this.sendMessage();
            }
        });

        // Auto-resize textarea
        this.messageInput.addEventListener('input', () => {
            this.messageInput.style.height = 'auto';
            this.messageInput.style.height = Math.min(this.messageInput.scrollHeight, 100) + 'px';
        });
    }

    toggleChat() {
        this.isOpen = !this.isOpen;

        if (this.isOpen) {
            this.chatPanel.classList.add('open');
            this.unreadCount = 0;
            this.updateBadge();
            this.scrollToBottom();
            this.messageInput.focus();
        } else {
            this.chatPanel.classList.remove('open');
        }
    }

    async sendMessage() {
        const message = this.messageInput.value.trim();
        if (!message) return;

        try {
            const response = await fetch(`/canvas/api/project/${this.projectId}/chat/messages`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: message,
                    message_type: 'text',
                }),
            });

            const result = await response.json();

            if (result.success) {
                this.messageInput.value = '';
                this.messageInput.style.height = 'auto';
                this.addMessage(result.message);
                this.scrollToBottom();
            } else {
                console.error('Failed to send message:', result.message);
                alert('Failed to send message: ' + result.message);
            }
        } catch (error) {
            console.error('Error sending message:', error);
            alert('Error sending message: ' + error.message);
        }
    }

    async loadMessages() {
        try {
            const response = await fetch(`/canvas/api/project/${this.projectId}/chat/messages`);
            const result = await response.json();

            if (result.success) {
                const newMessages = result.messages.filter(msg => 
                    !this.messages.find(existing => existing.id === msg.id)
                );

                newMessages.forEach(message => {
                    this.addMessage(message);

                    // Count unread messages from other users
                    if (message.user_id !== this.currentUser.id && !this.isOpen) {
                        this.unreadCount++;
                    }
                });

                this.updateBadge();

                if (newMessages.length > 0 && this.isOpen) {
                    this.scrollToBottom();
                }
            }
        } catch (error) {
            console.error('Error loading messages:', error);
        }
    }

    addMessage(messageData) {
        // Check if message already exists
        if (this.messages.find(msg => msg.id === messageData.id)) {
            return;
        }

        this.messages.push(messageData);

        const messageElement = this.createMessageElement(messageData);
        this.chatMessages.appendChild(messageElement);

        // Animate message appearance
        messageElement.style.opacity = '0';
        messageElement.style.transform = 'translateY(20px)';

        requestAnimationFrame(() => {
            messageElement.style.transition = 'all 0.3s ease';
            messageElement.style.opacity = '1';
            messageElement.style.transform = 'translateY(0)';
        });
    }

    createMessageElement(messageData) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-message ${messageData.user_id === this.currentUser.id ? 'own' : 'other'}`;

        const time = new Date(messageData.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

        messageDiv.innerHTML = `
            <div class="message-header">
                <span class="message-author">${messageData.user_name || 'Unknown User'}</span>
                <span class="message-time">${time}</span>
            </div>
            <div class="message-content">${messageData.message}</div>
        `;

        return messageDiv;
    }

    updateBadge() {
        if (this.unreadCount > 0) {
            this.badge.textContent = this.unreadCount > 99 ? '99+' : this.unreadCount;
            this.badge.style.display = 'inline-block';
        } else {
            this.badge.style.display = 'none';
        }
    }

    scrollToBottom() {
        requestAnimationFrame(() => {
            this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
        });
    }
}

// Initialize project chat
document.addEventListener('DOMContentLoaded', function() {
    {% if is_member %}
    window.projectChat = new ProjectChat();
    {% endif %}
});

// User search functionality
document.getElementById('userSearch').addEventListener('input', function() {
    const query = this.value.trim();
    
    clearTimeout(searchTimeout);
    
    if (query.length < 2) {
        document.getElementById('searchResults').style.display = 'none';
        return;
    }
    
    searchTimeout = setTimeout(() => {
        searchUsers(query);
    }, 300);
});

function searchUsers(query) {
    fetch(`/invitations/search-users?q=${encodeURIComponent(query)}&project_id={{ project.id }}`)
        .then(response => response.json())
        .then(data => {
            displaySearchResults(data.users);
        })
        .catch(error => {
            console.error('Error searching users:', error);
        });
}

function displaySearchResults(users) {
    const userList = document.getElementById('userList');
    const searchResults = document.getElementById('searchResults');
    
    userList.innerHTML = '';
    
    if (users.length === 0) {
        userList.innerHTML = '<div class="list-group-item text-muted">No users found</div>';
    } else {
        users.forEach(user => {
            const userItem = document.createElement('div');
            userItem.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
            userItem.innerHTML = `
                <div>
                    <div class="fw-bold">${user.full_name}</div>
                    <small class="text-muted">${user.email}</small>
                    ${user.department ? `<br><small class="text-muted">${user.department}</small>` : ''}
                </div>
                <button class="btn btn-sm btn-outline-primary" onclick="selectUser(${user.id}, '${user.full_name}', '${user.email}')">
                    <i class="fas fa-plus"></i> Select
                </button>
            `;
            userList.appendChild(userItem);
        });
    }
    
    searchResults.style.display = 'block';
}

function selectUser(userId, fullName, email) {
    if (selectedUsers.find(u => u.id === userId)) {
        return; // Already selected
    }
    
    selectedUsers.push({ id: userId, name: fullName, email: email });
    updateSelectedUsers();
}

function removeUser(userId) {
    selectedUsers = selectedUsers.filter(u => u.id !== userId);
    updateSelectedUsers();
}

function updateSelectedUsers() {
    const selectedDiv = document.getElementById('selectedUsers');
    const selectedList = document.getElementById('selectedUsersList');
    const sendButton = document.getElementById('sendInvitations');
    
    if (selectedUsers.length === 0) {
        selectedDiv.style.display = 'none';
        sendButton.style.display = 'none';
        return;
    }
    
    selectedList.innerHTML = '';
    selectedUsers.forEach(user => {
        const userTag = document.createElement('span');
        userTag.className = 'badge bg-primary me-2 mb-2 p-2';
        userTag.innerHTML = `
            ${user.name}
            <button type="button" class="btn-close btn-close-white ms-2" onclick="removeUser(${user.id})" style="font-size: 0.7em;"></button>
        `;
        selectedList.appendChild(userTag);
    });
    
    selectedDiv.style.display = 'block';
    sendButton.style.display = 'block';
}

// Send invitations
document.getElementById('sendInvitations').addEventListener('click', function() {
    const role = document.getElementById('inviteRole').value;
    const message = document.getElementById('inviteMessage').value;
    
    this.disabled = true;
    this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Sending...';
    
    const promises = selectedUsers.map(user => {
        return fetch('/invitations/invite', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                project_id: {{ project.id }},
                user_id: user.id,
                role: role,
                message: message
            })
        });
    });
    
    Promise.all(promises)
        .then(responses => Promise.all(responses.map(r => r.json())))
        .then(results => {
            const successful = results.filter(r => r.success).length;
            const failed = results.filter(r => !r.success).length;
            
            if (successful > 0) {
                Utils.showToast(`${successful} invitation(s) sent successfully!`, 'success');
            }
            if (failed > 0) {
                Utils.showToast(`${failed} invitation(s) failed to send.`, 'warning');
            }
            
            // Reset form
            selectedUsers = [];
            updateSelectedUsers();
            document.getElementById('userSearch').value = '';
            document.getElementById('searchResults').style.display = 'none';
            document.getElementById('inviteMessage').value = '';
            
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('inviteModal')).hide();
        })
        .catch(error => {
            console.error('Error sending invitations:', error);
            Utils.showToast('Error sending invitations.', 'error');
        })
        .finally(() => {
            this.disabled = false;
            this.innerHTML = '<i class="fas fa-paper-plane me-1"></i> Send Invitations';
        });
});

// Auto-update project progress when tasks are updated
document.addEventListener('DOMContentLoaded', function() {
    // Update progress after task status changes
    if (typeof TaskManager !== 'undefined') {
        const originalUpdateStatus = TaskManager.updateStatus;
        TaskManager.updateStatus = function(taskId, status) {
            originalUpdateStatus.call(this, taskId, status).then(() => {
                // Refresh the page to show updated progress
                setTimeout(() => {
                    location.reload();
                }, 1000);
            });
        };
    }
});
</script>
{% endblock %}
